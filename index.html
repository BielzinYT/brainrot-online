<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Brain Rot Online</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 20px 60px 20px; /* Extra bottom padding */
            overflow: hidden;
        }

        #game-area {
            position: relative;
            width: 1200px;
            height: 800px;
            background-color: #333;
            border: 5px solid #222;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        #money-display {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ffeb3b;
            font-size: 18px;
            font-weight: bold;
            z-index: 200;
            transition: all 0.3s ease-out;
        }

        #money-display.updated {
            transform: scale(1.1);
            text-shadow: 0 0 10px #ffeb3b;
        }

        #event-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            z-index: 300;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Modal Styles */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 3px solid #ffeb3b;
            max-width: 400px;
            text-align: center;
        }

        #modal-content p {
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        #modal-close {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #modal-close:hover {
            background: linear-gradient(45deg, #ee5a24, #ff6b6b);
            transform: scale(1.05);
        }

        #restore-notification {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 300;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }

        #admin-controls {
            position: absolute;
            bottom: 20px; /* At the bottom of the page */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 200;
        }

        #admin-controls button {
            background-color: #ff0000;
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        #admin-controls button:hover {
            background-color: #cc0000;
        }

        #admin-button {
            background-color: #ff4444;
        }

        #admin-button:hover {
            background-color: #cc3333;
        }

        .player {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ffeb3b;
            border-radius: 50%;
            border: 2px solid #2c2c2c;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
            z-index: 100;
            transition: all 0.1s ease-out;
            transform: translate(-50%, -50%);
        }

        .player-name {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: white;
            white-space: nowrap;
        }

        .base {
            position: absolute;
            width: 250px;
            height: 150px;
            border: 3px solid #6a1b9a;
            background-color: #444;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 5px;
            box-sizing: border-box;
        }

        .base-row {
            display: flex;
            gap: 5px;
            justify-content: space-between;
        }
        
        /* Ajuste para garantir que a base do jogador tenha a cor correta */
        .base.my-base { 
            border: 3px solid #ffeb3b;
        }

        .base-label {
            position: absolute;
            top: -20px;
            left: 5px;
            color: #e0e0e0;
        }

        .slot {
            width: 50px;
            height: 50px;
            background-color: #555;
            border: 2px dashed #777;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            text-align: center;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .sell-btn {
            font-size: 6px;
            padding: 2px 4px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .sell-btn:hover {
            background-color: #45a049;
        }

        .lock-btn {
            width: 100%;
            padding: 5px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            margin-bottom: 5px;
        }

        .lock-btn:hover {
            background-color: #e68900;
        }

        .base.locked {
            border-color: #ff0000 !important;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .base.locked .base-label::after {
            content: " ðŸ”’";
            color: #ff0000;
            font-weight: bold;
        }

        .upgrade-section {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .upgrade-btn {
            width: 40px;
            padding: 3px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 8px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .upgrade-btn:hover {
            background-color: #1976D2;
            transform: scale(1.05);
        }

        /* Tooltip system */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            border: 1px solid #555;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            max-width: 300px;
            font-size: 14px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .capacity-btn {
            background-color: #4CAF50;
        }

        .capacity-btn:hover {
            background-color: #45a049;
        }

        .generation-btn {
            background-color: #FF9800;
        }

        .generation-btn:hover {
            background-color: #e68900;
        }

        #conveyor-belt {
            position: absolute;
            width: 100px; /* Largura do tapete */
            height: 700px; /* Altura do tapete */
            background-color: #b71c1c;
            border-radius: 15px;
            border: 5px solid #8e0000;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
        }

        /* Particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 60;
        }

        .spawn-particle {
            width: 4px;
            height: 4px;
            background-color: #ffeb3b;
            border-radius: 50%;
            box-shadow: 0 0 6px #ffeb3b;
        }

        .collect-particle {
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #4CAF50, #45a049);
            border-radius: 50%;
            box-shadow: 0 0 8px #4CAF50;
        }

        .sell-particle {
            width: 5px;
            height: 5px;
            background: radial-gradient(circle, #ffeb3b, #ffb300);
            border-radius: 50%;
            box-shadow: 0 0 10px #ffeb3b;
        }

        .steal-particle {
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ff4444, #cc3333);
            border-radius: 50%;
            box-shadow: 0 0 12px #ff4444;
        }

        .brain-rot-item {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            text-align: center;
            color: white;
            z-index: 50; /* Para aparecer abaixo do player, mas acima do tapete */
            transition: all 0.15s ease-out;
            transform: translate(-50%, -50%);
        }

        .brain-rot-item:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
        }

        .brain-rot-item.collecting {
            animation: collectPulse 0.3s ease-out;
        }

        @keyframes collectPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }

        /* Raridades CSS */
        .common { background-color: #757575; color: white; }
        .rare { background-color: #29b6f6; color: white; }
        .epic { background-color: #ab47bc; color: white; }
        .legendary { background-color: #ffb300; color: #424242; }
        .mythic { background-color: #ff0000; color: white; }
        .god { background-color: #43a047; color: white; }
        .secret { background-color: #000000; color: #ffeb3b; border: 2px dashed #ffeb3b; }
        .og { background-color: #6a1b9a; color: #ffeb3b; border: 2px solid #ffeb3b; }
        .galactic { background: radial-gradient(circle, #f3e5f5 0%, #ba68c8 100%); color: #424242; border: 2px solid #9c27b0; }
        .cosmic { background: radial-gradient(circle, #80deea 0%, #00acc1 100%); color: #1e88e5; border: 2px solid #0097a7; }
        .transcendental { background: linear-gradient(45deg, #FF6F61, #C724B1, #5D3FD3); color: #fff; border: 2px solid #fff; }
        .paradoxal { background: linear-gradient(135deg, #00C9FF, #92FE9D); color: #000; border: 2px solid #000; }
        .eternal { background: radial-gradient(circle, #FFD700 0%, #FFA500 100%); color: #424242; border: 2px solid #FFD700; box-shadow: 0 0 10px 5px #FFD700; }
        .divine { background: radial-gradient(circle, #E0B0FF 0%, #8A2BE2 100%); color: #fff; border: 2px solid #E0B0FF; box-shadow: 0 0 10px 5px #E0B0FF; }
        .cosmologic { background: radial-gradient(circle, #B2F0FF 0%, #4D8DFF 100%); color: #000; border: 2px solid #4D8DFF; }
        .final { background: radial-gradient(circle, #FFE5E5 0%, #FFB2B2 100%); color: #000; border: 2px solid #FFB2B2; }
        .mystic { background: radial-gradient(circle, #E6E6FA 0%, #DDA0DD 100%); color: #4B0082; border: 2px solid #8A2BE2; }
        .immortal { background: linear-gradient(45deg, #FFD700, #FF4500); color: #000; border: 2px solid #FFD700; }
        .absolute { background: linear-gradient(90deg, #000000, #FFFFFF, #000000); color: #FFF; border: 2px solid #FFF; }

        /* Responsive Design */
        @media (max-width: 1400px) {
            #game-area {
                width: 1000px;
                height: 667px;
            }

            .base {
                width: 200px;
                height: 120px;
            }

            .slot {
                width: 40px;
                height: 40px;
            }

            .upgrade-btn {
                width: 35px;
                font-size: 7px;
            }
        }

        @media (max-width: 1100px) {
            #game-area {
                width: 800px;
                height: 533px;
            }

            .base {
                width: 160px;
                height: 96px;
            }

            .slot {
                width: 32px;
                height: 32px;
                font-size: 6px;
            }

            .upgrade-btn {
                width: 30px;
                font-size: 6px;
            }

            .base-label {
                font-size: 11px;
            }
        }

        @media (max-width: 900px) {
            body {
                padding: 10px;
            }

            #game-area {
                width: 100%;
                max-width: 600px;
                height: 400px;
            }

            .base {
                width: 120px;
                height: 72px;
            }

            .slot {
                width: 24px;
                height: 24px;
                font-size: 5px;
            }

            .upgrade-btn {
                width: 25px;
                font-size: 5px;
                padding: 2px;
            }

            .base-label {
                font-size: 10px;
            }

            #money-display {
                font-size: 14px;
            }
        }

        @media (max-width: 600px) {
            #game-area {
                height: 300px;
            }

            .base {
                width: 80px;
                height: 48px;
            }

            .slot {
                width: 16px;
                height: 16px;
                font-size: 4px;
            }

            .upgrade-btn {
                width: 20px;
                font-size: 4px;
                padding: 1px;
            }

            .base-label {
                font-size: 8px;
            }

            #money-display {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1 style="font-size: 48px; margin-bottom: 40px;">Brain Rot Online</h1>
        <div style="background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
            <label for="username" style="font-size: 24px; margin-bottom: 20px; display: block;">Seu nome de usuÃ¡rio:</label>
            <input type="text" id="username" maxlength="20" style="width: 300px; padding: 15px; font-size: 18px; border: none; border-radius: 8px; margin-bottom: 30px;" placeholder="Digite seu nome...">
            <button id="enter-button" style="width: 320px; padding: 15px; font-size: 20px; background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">Entrar</button>
        </div>
    </div>

    <!-- Menu Screen -->
    <div id="menu-screen" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1 style="font-size: 48px; margin-bottom: 40px;">Escolha o Modo de Jogo</h1>
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <button class="menu-button" data-mode="solo" style="width: 300px; padding: 20px; font-size: 24px; background: linear-gradient(45deg, #4CAF50, #45a049); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Jogar Sozinho</button>
            <button class="menu-button" data-mode="online" style="width: 300px; padding: 20px; font-size: 24px; background: linear-gradient(45deg, #2196F3, #1976D2); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s;">Jogar Online</button>
        </div>
    </div>

    <div id="game-area" style="display: none;">
        <div id="money-display">Dinheiro: $250</div>
        <div id="event-message" style="display: none;">EVENTO ATIVO!</div>
        <div id="restore-notification">Dados restaurados! âœ…</div>
        <div id="admin-controls" style="display: none;">
            <button id="admin-button">Ativar Evento</button>
            <button id="duration-30">30s</button>
            <button id="duration-60">60s</button>
            <button id="duration-120">120s</button>
        </div>

        <!-- Modal System -->
        <div id="modal-overlay" style="display: none;">
            <div id="modal">
                <div id="modal-content">
                    <p id="modal-message"></p>
                    <button id="modal-close">OK</button>
                </div>
            </div>
        </div>
        <div id="base-1" class="base" style="top: 50px; left: 50px;">
            <div class="base-label">Sua Base</div>
            <button id="lock-base-1" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <div class="tooltip">
                    <button id="upgrade-capacity-1" class="upgrade-btn capacity-btn">Cap+</button>
                    <span class="tooltip-text">Aumenta a capacidade do inventÃ¡rio<br>Custo: $500 â†’ $1,500 â†’ $4,000 â†’ $10,000 â†’ $25,000</span>
                </div>
                <div class="tooltip">
                    <button id="upgrade-generation-1" class="upgrade-btn generation-btn">Gen+</button>
                    <span class="tooltip-text">Aumenta a geraÃ§Ã£o de dinheiro<br>Custo: $1,000 â†’ $3,000 â†’ $8,000 â†’ $20,000 â†’ $50,000</span>
                </div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>
        <div id="base-3" class="base" style="top: 325px; left: 50px;">
            <div class="base-label">Base 3</div>
            <button id="lock-base-3" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="upgrade-capacity-3" class="upgrade-btn capacity-btn" title="Aumentar Capacidade">Cap+</button>
                <button id="upgrade-generation-3" class="upgrade-btn generation-btn" title="Aumentar GeraÃ§Ã£o">Gen+</button>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>
        <div id="base-5" class="base" style="bottom: 50px; left: 50px;">
            <div class="base-label">Base 5</div>
            <button id="lock-base-5" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="upgrade-capacity-5" class="upgrade-btn capacity-btn" title="Aumentar Capacidade">Cap+</button>
                <button id="upgrade-generation-5" class="upgrade-btn generation-btn" title="Aumentar GeraÃ§Ã£o">Gen+</button>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>

        <div id="base-2" class="base" style="top: 50px; right: 50px;">
            <div class="base-label">Base 2</div>
            <button id="lock-base-2" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="upgrade-capacity-2" class="upgrade-btn capacity-btn" title="Aumentar Capacidade">Cap+</button>
                <button id="upgrade-generation-2" class="upgrade-btn generation-btn" title="Aumentar GeraÃ§Ã£o">Gen+</button>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>
        <div id="base-4" class="base" style="top: 325px; right: 50px;">
            <div class="base-label">Base 4</div>
            <button id="lock-base-4" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="upgrade-capacity-4" class="upgrade-btn capacity-btn" title="Aumentar Capacidade">Cap+</button>
                <button id="upgrade-generation-4" class="upgrade-btn generation-btn" title="Aumentar GeraÃ§Ã£o">Gen+</button>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>
        <div id="base-6" class="base" style="bottom: 50px; right: 50px;">
            <div class="base-label">Base 6</div>
            <button id="lock-base-6" class="lock-btn" style="display: none;">Bloquear Base (60s)</button>
            <div class="upgrade-section" style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button id="upgrade-capacity-6" class="upgrade-btn capacity-btn" title="Aumentar Capacidade">Cap+</button>
                <button id="upgrade-generation-6" class="upgrade-btn generation-btn" title="Aumentar GeraÃ§Ã£o">Gen+</button>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
            <div class="base-row">
                <div class="slot"></div>
                <div class="slot"></div>
                <div class="slot"></div>
            </div>
        </div>

        <div id="conveyor-belt"></div>

        <!-- Audio elements for sound effects -->
        <audio id="bg-music" loop preload="auto">
            <source src="sounds/background.mp3" type="audio/mpeg">
            <source src="sounds/background.ogg" type="audio/ogg">
        </audio>
        <audio id="pickup-sound" preload="auto">
            <source src="sounds/pickup.mp3" type="audio/mpeg">
            <source src="sounds/pickup.ogg" type="audio/ogg">
        </audio>
        <audio id="sell-sound" preload="auto">
            <source src="sounds/sell.mp3" type="audio/mpeg">
            <source src="sounds/sell.ogg" type="audio/ogg">
        </audio>
        <audio id="steal-sound" preload="auto">
            <source src="sounds/steal.mp3" type="audio/mpeg">
            <source src="sounds/steal.ogg" type="audio/ogg">
        </audio>
        <audio id="event-sound" preload="auto">
            <source src="sounds/event.mp3" type="audio/mpeg">
            <source src="sounds/event.ogg" type="audio/ogg">
        </audio>
        <audio id="lock-sound" preload="auto">
            <source src="sounds/lock.mp3" type="audio/mpeg">
            <source src="sounds/lock.ogg" type="audio/ogg">
        </audio>
    </div>

    <script>
        let username = localStorage.getItem('brainrot_username') || '';
        let gameMode = '';

        // Load saved username on page load
        window.addEventListener('load', () => {
            if (username) {
                document.getElementById('username').value = username;
            }
        });

        // Login screen logic
        document.getElementById('enter-button').addEventListener('click', () => {
            const input = document.getElementById('username');
            if (input.value.trim()) {
                username = input.value.trim();
                localStorage.setItem('brainrot_username', username);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('menu-screen').style.display = 'flex';
            } else {
                alert('Por favor, digite um nome de usuÃ¡rio!');
            }
        });

        // Menu buttons logic
        document.querySelectorAll('.menu-button').forEach(button => {
            button.addEventListener('click', () => {
                gameMode = button.dataset.mode;
                document.getElementById('menu-screen').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                startGame();
            });
        });

        function startGame() {
            const socket = io();
            const gameArea = document.getElementById('game-area');
            const players = {};
            const brainRots = {};
            let myId;
            let myPlayer;

            // Sound manager
            const soundManager = {
                bgMusic: document.getElementById('bg-music'),
                pickupSound: document.getElementById('pickup-sound'),
                sellSound: document.getElementById('sell-sound'),
                stealSound: document.getElementById('steal-sound'),
                eventSound: document.getElementById('event-sound'),
                lockSound: document.getElementById('lock-sound'),

                play: function(sound) {
                    if (sound && sound.readyState >= 2) { // HAVE_CURRENT_DATA or higher
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                },

                startBackgroundMusic: function() {
                    this.play(this.bgMusic);
                },

                stopBackgroundMusic: function() {
                    this.bgMusic.pause();
                    this.bgMusic.currentTime = 0;
                }
            };

            // Start background music when game starts
            soundManager.startBackgroundMusic();

            // Object Pool for Brain Rots (performance optimization)
            const brainRotPool = {
                pool: [],
                active: new Set(),

                create: function() {
                    let rotDiv = this.pool.pop();
                    if (!rotDiv) {
                        rotDiv = document.createElement('div');
                        rotDiv.classList.add('brain-rot-item');
                        gameArea.appendChild(rotDiv);
                    }
                    this.active.add(rotDiv);
                    return rotDiv;
                },

                release: function(rotDiv) {
                    if (this.active.has(rotDiv)) {
                        rotDiv.style.display = 'none';
                        this.active.delete(rotDiv);
                        this.pool.push(rotDiv);
                    }
                },

                clear: function() {
                    for (const rotDiv of this.active) {
                        rotDiv.style.display = 'none';
                        this.pool.push(rotDiv);
                    }
                    this.active.clear();
                }
            };

            // Particle system with object pooling
            const particleSystem = {
                particles: [],
                pool: [],
                gameArea: gameArea,

                createParticle: function(x, y, type, count = 5) {
                    for (let i = 0; i < count; i++) {
                        let particle = this.pool.pop();
                        if (!particle) {
                            particle = document.createElement('div');
                            particle.className = `particle ${type}-particle`;
                            this.gameArea.appendChild(particle);
                        }

                        particle.className = `particle ${type}-particle`;
                        particle.style.left = `${x}px`;
                        particle.style.top = `${y}px`;
                        particle.style.display = 'block';

                        // Random velocity
                        const angle = Math.random() * Math.PI * 2;
                        const speed = Math.random() * 3 + 1;
                        const vx = Math.cos(angle) * speed;
                        const vy = Math.sin(angle) * speed;

                        particle.vx = vx;
                        particle.vy = vy;
                        particle.life = 60; // 60 frames lifetime
                        particle.gravity = 0.1;

                        this.particles.push(particle);
                    }
                },

                update: function() {
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const particle = this.particles[i];
                        particle.life--;

                        if (particle.life <= 0) {
                            particle.style.display = 'none';
                            this.pool.push(particle);
                            this.particles.splice(i, 1);
                            continue;
                        }

                        // Update position
                        const currentX = parseFloat(particle.style.left);
                        const currentY = parseFloat(particle.style.top);

                        particle.vx *= 0.98; // Friction
                        particle.vy += particle.gravity; // Gravity

                        particle.style.left = `${currentX + particle.vx}px`;
                        particle.style.top = `${currentY + particle.vy}px`;

                        // Fade out
                        const opacity = particle.life / 60;
                        particle.style.opacity = opacity;
                    }
                }
            };

            // Update particle system in game loop
            const originalGameLoop = gameLoop;
            gameLoop = function() {
                particleSystem.update();
                originalGameLoop();
            };

            // Send username and mode on connection
            socket.on('connect', () => {
                console.log('Conectado ao servidor!');
                myId = socket.id;
                socket.emit('joinGame', { username, mode: gameMode });
            });

        const CONVEYOR_BELT_PROPS = {
            x: gameArea.offsetWidth / 2 - 100 / 2, // Centraliza no mapa
            y: gameArea.offsetHeight / 2 - 700 / 2, // Centraliza no mapa
            width: 100,
            height: 700
        };

        const BRAIN_ROT_TYPES = [
            { name: 'Skibidi Toilet', rarity: 'Comum', price: 10, sellPrice: 5, generationRate: 0.1, class: 'common' },
            { name: 'Sigma Face', rarity: 'Comum', price: 12, sellPrice: 6, generationRate: 0.12, class: 'common' },
            { name: 'Cbum', rarity: 'Raro', price: 50, sellPrice: 25, generationRate: 0.5, class: 'rare' },
            { name: 'Baby Gronk', rarity: 'Raro', price: 60, sellPrice: 30, generationRate: 0.6, class: 'rare' },
            { name: 'NPC Streamer', rarity: 'Ã‰pico', price: 200, sellPrice: 100, generationRate: 2, class: 'epic' },
            { name: 'The Weeknd', rarity: 'Ã‰pico', price: 250, sellPrice: 125, generationRate: 2.5, class: 'epic' },
            { name: 'BebÃª DanÃ§ando', rarity: 'LendÃ¡rio', price: 1000, sellPrice: 500, generationRate: 10, class: 'legendary' },
            { name: 'Gato Cansado', rarity: 'LendÃ¡rio', price: 1200, sellPrice: 600, generationRate: 12, class: 'legendary' },
            { name: 'Morte ao Vivo', rarity: 'MÃ­tico', price: 2500, sellPrice: 1250, generationRate: 25, class: 'mythic' },
            { name: 'Brain Rot God', rarity: 'Deus', price: 5000, sellPrice: 2500, generationRate: 50, class: 'god' },
            { name: 'OG Meme', rarity: 'OG', price: 8000, sellPrice: 4000, generationRate: 80, class: 'og' },
            { name: 'Brainrot Secreto', rarity: 'Secreto', price: 15000, sellPrice: 7500, generationRate: 150, class: 'secret' },
            { name: 'AnimaÃ§Ã£o 3D do Minecraft', rarity: 'Galactic', price: 25000, sellPrice: 12500, generationRate: 250, class: 'galactic' },
            { name: 'Sopa de Letrinhas', rarity: 'Galactic', price: 30000, sellPrice: 15000, generationRate: 300, class: 'galactic' },
            { name: 'GigaChad', rarity: 'Cosmic', price: 50000, sellPrice: 25000, generationRate: 500, class: 'cosmic' },
            { name: 'Meme do Mago', rarity: 'Cosmic', price: 60000, sellPrice: 30000, generationRate: 600, class: 'cosmic' },
            { name: 'Dancinha do Tik Tok', rarity: 'Transcendental', price: 150000, sellPrice: 75000, generationRate: 1500, class: 'transcendental' },
            { name: 'Morte do Jogo do Roblox', rarity: 'Transcendental', price: 180000, sellPrice: 90000, generationRate: 1800, class: 'transcendental' },
            { name: 'Portal para Outra DimensÃ£o', rarity: 'Paradoxal', price: 500000, sellPrice: 250000, generationRate: 5000, class: 'paradoxal' },
            { name: 'O ComeÃ§o de Tudo', rarity: 'Paradoxal', price: 750000, sellPrice: 375000, generationRate: 7500, class: 'paradoxal' },
            { name: 'O Fim da Jornada', rarity: 'Eterno', price: 1500000, sellPrice: 750000, generationRate: 15000, class: 'eternal' },
            { name: 'Eterno Retorno', rarity: 'Eterno', price: 2000000, sellPrice: 1000000, generationRate: 20000, class: 'eternal' },
            { name: 'O Vazio do Universo', rarity: 'Divino', price: 5000000, sellPrice: 2500000, generationRate: 50000, class: 'divine' },
            { name: 'A EssÃªncia da ExistÃªncia', rarity: 'Divino', price: 10000000, sellPrice: 5000000, generationRate: 100000, class: 'divine' },
            { name: 'O GuardiÃ£o do Tempo', rarity: 'MÃ­stico', price: 25000000, sellPrice: 12500000, generationRate: 250000, class: 'mystic' },
            { name: 'O CÃ³digo da Realidade', rarity: 'MÃ­stico', price: 50000000, sellPrice: 25000000, generationRate: 500000, class: 'mystic' },
            { name: 'A Lenda de Outro Mundo', rarity: 'LendÃ¡rio', price: 100000000, sellPrice: 50000000, generationRate: 1000000, class: 'legendary-new' },
            { name: 'O Deus Supremo', rarity: 'LendÃ¡rio', price: 200000000, sellPrice: 100000000, generationRate: 2000000, class: 'legendary-new' },
            { name: 'Fragmento do Imortal', rarity: 'Imortal', price: 500000000, sellPrice: 250000000, generationRate: 5000000, class: 'immortal' },
            { name: 'O Sussurro do Caos', rarity: 'Imortal', price: 1000000000, sellPrice: 500000000, generationRate: 10000000, class: 'immortal' },
            { name: 'A AscensÃ£o Absoluta', rarity: 'Absoluto', price: 5000000000, sellPrice: 2500000000, generationRate: 50000000, class: 'absolute' },
            { name: 'O Fim de Tudo', rarity: 'Absoluto', price: 10000000000, sellPrice: 5000000000, generationRate: 100000000, class: 'absolute' },
            { name: 'Chuva de Metade', rarity: 'CosmolÃ³gico', price: 500000000000, sellPrice: 250000000000, generationRate: 500000000, class: 'cosmologic' },
            { name: 'A CrianÃ§a do Apocalipse', rarity: 'CosmolÃ³gico', price: 1000000000000, sellPrice: 500000000000, generationRate: 1000000000, class: 'cosmologic' },
            { name: 'O CoraÃ§Ã£o do Universo', rarity: 'Final', price: 50000000000000, sellPrice: 25000000000000, generationRate: 50000000000, class: 'final' },
            { name: 'O Fim da HistÃ³ria', rarity: 'Final', price: 100000000000000, sellPrice: 50000000000000, generationRate: 100000000000, class: 'final' },
            { name: 'DanÃ§a do Fanum Tax', rarity: 'Comum', price: 15, sellPrice: 7, generationRate: 0.15, class: 'common' },
            { name: 'Rizzler Supremo', rarity: 'Raro', price: 70, sellPrice: 35, generationRate: 0.7, class: 'rare' },
            { name: 'Ohio Mode Activated', rarity: 'Ã‰pico', price: 300, sellPrice: 150, generationRate: 3, class: 'epic' },
            { name: 'Skibidi Rizz', rarity: 'LendÃ¡rio', price: 1500, sellPrice: 750, generationRate: 15, class: 'legendary' },
            { name: 'Brainrot Overload', rarity: 'MÃ­tico', price: 3000, sellPrice: 1500, generationRate: 30, class: 'mythic' },
            { name: 'Sigma Male Grindset', rarity: 'Deus', price: 6000, sellPrice: 3000, generationRate: 60, class: 'god' },
            { name: 'Fanum Tax Collector', rarity: 'OG', price: 10000, sellPrice: 5000, generationRate: 100, class: 'og' },
            { name: 'Rizz God Emperor', rarity: 'Galactic', price: 35000, sellPrice: 17500, generationRate: 350, class: 'galactic' },
            { name: 'Ohio Sigma King', rarity: 'Cosmic', price: 70000, sellPrice: 35000, generationRate: 700, class: 'cosmic' },
            { name: 'Brainrot Apocalypse', rarity: 'Transcendental', price: 200000, sellPrice: 100000, generationRate: 2000, class: 'transcendental' },
            { name: 'Infinite Rizz Loop', rarity: 'Paradoxal', price: 1000000, sellPrice: 500000, generationRate: 10000, class: 'paradoxal' },
            { name: 'Sigma Rule #1', rarity: 'Eterno', price: 3000000, sellPrice: 1500000, generationRate: 30000, class: 'eternal' },
            { name: 'Fanum Tax Empire', rarity: 'Divino', price: 15000000, sellPrice: 7500000, generationRate: 150000, class: 'divine' },
            { name: 'Rizz Dimension', rarity: 'MÃ­stico', price: 30000000, sellPrice: 15000000, generationRate: 300000, class: 'mystic' },
            { name: 'Ohio Overlord', rarity: 'Imortal', price: 1500000000, sellPrice: 750000000, generationRate: 15000000, class: 'immortal' },
            { name: 'Brainrot Singularity', rarity: 'Absoluto', price: 10000000000000, sellPrice: 5000000000000, generationRate: 100000000000, class: 'absolute' }
        ];

        const keys = {};
        let zoom = 1;
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        const BASE_POSITIONS = {
            'base-1': { x: 50 + 250/2, y: 50 + 150/2 },
            'base-2': { x: 1200 - 50 - 250/2, y: 50 + 150/2 },
            'base-3': { x: 50 + 250/2, y: 325 + 150/2 },
            'base-4': { x: 1200 - 50 - 250/2, y: 325 + 150/2 },
            'base-5': { x: 50 + 250/2, y: 800 - 50 - 150/2 },
            'base-6': { x: 1200 - 50 - 250/2, y: 800 - 50 - 150/2 }
        };

        function gameLoop() {
            if (myPlayer) {
                let dx = 0;
                let dy = 0;
                const speed = 6; // Increased to 6 for even faster movement

                if (keys['w'] || keys['W'] || keys['ArrowUp']) dy -= 1;
                if (keys['s'] || keys['S'] || keys['ArrowDown']) dy += 1;
                if (keys['a'] || keys['A'] || keys['ArrowLeft']) dx -= 1;
                if (keys['d'] || keys['D'] || keys['ArrowRight']) dx += 1;

                // Normalize diagonal movement
                if (dx !== 0 && dy !== 0) {
                    const length = Math.sqrt(dx * dx + dy * dy);
                    dx = (dx / length) * speed;
                    dy = (dy / length) * speed;
                } else if (dx !== 0 || dy !== 0) {
                    dx *= speed;
                    dy *= speed;
                }

                if (dx !== 0 || dy !== 0) {
                    socket.emit('playerMove', { dx, dy });
                }

                // Camera zoom
                let minDist = Infinity;
                for (let baseId in BASE_POSITIONS) {
                    const dist = Math.sqrt((myPlayer.x + 15 - BASE_POSITIONS[baseId].x) ** 2 + (myPlayer.y + 15 - BASE_POSITIONS[baseId].y) ** 2);
                    if (dist < minDist) minDist = dist;
                }
                if (minDist < 100) {
                    zoom = Math.max(1.5, 2 - minDist / 100);
                } else {
                    zoom = 1;
                }
                gameArea.style.transform = `scale(${zoom})`;
                gameArea.style.transformOrigin = 'center';
            }
            requestAnimationFrame(gameLoop);
        }

        socket.on('connect', () => {
            console.log('Conectado ao servidor!');
            myId = socket.id;

            // Start heartbeat system
            setInterval(() => {
                socket.emit('heartbeat', { clientTime: Date.now() });
            }, 5000); // Send heartbeat every 5 seconds
        });

        socket.on('disconnect', (reason) => {
            console.log('Desconectado do servidor:', reason);
            showModal('ConexÃ£o perdida! Recarregue a pÃ¡gina para reconectar.');
        });

        socket.on('reconnect', (attemptNumber) => {
            console.log('Reconectado ao servidor apÃ³s', attemptNumber, 'tentativas');
            showNotification('Reconectado ao servidor!', 'success');
        });


        socket.on('assignBase', (data) => {
            const { baseId, playerId, baseNumber, isOwner, dataRestored } = data;
            if (playerId === myId) {
                const myBaseElement = document.getElementById(baseId);
                myBaseElement.classList.add('my-base');
                myBaseElement.querySelector('.base-label').textContent = "Sua Base";
                // Show admin controls if owner
                if (isOwner) {
                    document.getElementById('admin-controls').style.display = 'flex';
                }
                // Show lock button for own base
                const lockBtn = document.getElementById(`lock-base-${baseNumber}`);
                if (lockBtn) {
                    lockBtn.style.display = 'block';
                }
                // Show restore notification if data was restored
                if (dataRestored) {
                    console.log('Data restored, waiting for inventory update...');
                    const notification = document.getElementById('restore-notification');
                    notification.style.display = 'block';
                    setTimeout(() => {
                        notification.style.display = 'none';
                    }, 3000);
                }
            }
        });

        socket.on('updateBaseLocks', (serverPlayers) => {
            for (let playerId in serverPlayers) {
                const player = serverPlayers[playerId];
                const baseElement = document.getElementById(player.baseId);
                if (baseElement) {
                    if (player.baseLocked && Date.now() < player.baseLockTime) {
                        baseElement.classList.add('locked');
                    } else {
                        baseElement.classList.remove('locked');
                    }
                }
            }
        });

        socket.on('clearBaseBrainrots', (data) => {
            console.log('Clearing brainrots from base:', data.baseId);
            const baseElement = document.getElementById(data.baseId);
            if (baseElement) {
                const slots = baseElement.querySelectorAll('.slot');
                slots.forEach(slot => {
                    slot.innerHTML = '';
                    slot.className = 'slot';
                });
            }
        });

        socket.on('serverFull', (message) => {
            showModal(message);
        });

        socket.on('updateMoney', (serverPlayers) => {
            if (serverPlayers[myId]) {
                const moneyDisplay = document.getElementById('money-display');
                const oldMoney = parseFloat(moneyDisplay.textContent.replace('Dinheiro: $', '')) || 0;
                const newMoney = Math.floor(serverPlayers[myId].money);

                moneyDisplay.textContent = `Dinheiro: $${newMoney}`;

                // Add animation if money increased
                if (newMoney > oldMoney) {
                    moneyDisplay.classList.add('updated');
                    setTimeout(() => {
                        moneyDisplay.classList.remove('updated');
                    }, 300);
                }
            }
        });

        let flashInterval;
        socket.on('adminEvent', (data) => {
            const eventMessage = document.getElementById('event-message');
            if (data.active) {
                // Play event sound
                soundManager.play(soundManager.eventSound);

                // Show blinking message for 5 seconds only
                eventMessage.style.display = 'block';
                setTimeout(() => {
                    eventMessage.style.display = 'none';
                }, 5000); // Hide after 5 seconds

                // Start colorful flashing effect for the full duration
                const duration = data.duration || 30000;
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8000', '#8000ff'];
                let elapsed = 0;
                let colorIndex = 0;
                flashInterval = setInterval(() => {
                    gameArea.style.backgroundColor = colors[colorIndex % colors.length];
                    colorIndex++;
                    elapsed += 200; // Change color every 200ms
                    if (elapsed >= duration) {
                        clearInterval(flashInterval);
                        gameArea.style.backgroundColor = '#333';
                    }
                }, 200);
                showModal('EVENTO ADMIN ATIVADO! Rares aumentados por ' + (duration / 1000) + ' segundos!');
            } else {
                if (flashInterval) {
                    clearInterval(flashInterval);
                    gameArea.style.backgroundColor = '#333';
                }
                eventMessage.style.display = 'none';
                showModal('Evento Admin desativado.');
            }
        });

        socket.on('pickupFailed', (message) => {
            showModal(message || 'Falha ao coletar Brain Rot.');
        });

        socket.on('stealFailed', (message) => {
            showModal(message || 'Falha ao roubar Brain Rot.');
        });

        socket.on('sellFailed', (message) => {
            showModal(message || 'Falha ao vender Brain Rot.');
        });

        socket.on('moveRejected', (message) => {
            showModal(message || 'Movimento rejeitado.');
        });

        socket.on('lockFailed', (message) => {
            showModal(message || 'Falha ao bloquear base.');
        });

        socket.on('upgradeFailed', (message) => {
            showModal(message || 'Falha no upgrade.');
        });

        socket.on('adminEventFailed', (message) => {
            showModal(message || 'Falha no evento admin.');
        });

        socket.on('serverError', (message) => {
            showModal('Erro do servidor: ' + (message || 'Erro desconhecido.'));
        });

        socket.on('serverFull', (message) => {
            showModal(message || 'Servidor cheio.');
        });

        socket.on('upgradeSuccess', (data) => {
            const { upgradeType, newLevel, newValue, remainingMoney } = data;
            let message = '';
            if (upgradeType === 'capacity') {
                message = `Capacidade aumentada para ${newValue} slots!`;
            } else {
                message = `GeraÃ§Ã£o aumentada para ${newValue}x!`;
            }
            showNotification(`Upgrade realizado! ${message}`, 'success');

            // Update money display
            document.getElementById('money-display').textContent = `Dinheiro: $${remainingMoney}`;
        });

        socket.on('upgradeFailed', (message) => {
            showModal(message);
        });

        socket.on('updatePlayers', (serverPlayers) => {
            for (let id in serverPlayers) {
                if (!players[id]) {
                    const playerDiv = document.createElement('div');
                    playerDiv.classList.add('player');
                    playerDiv.id = id;
                    const playerName = document.createElement('span');
                    playerName.classList.add('player-name');
                    if (id === myId) {
                        playerName.textContent = username;
                        myPlayer = serverPlayers[id];
                    } else {
                        playerName.textContent = serverPlayers[id].username || `Jogador ${Object.keys(players).length + 1}`;
                    }
                    playerDiv.appendChild(playerName);
                    gameArea.appendChild(playerDiv);
                    players[id] = playerDiv;
                }

                const player = players[id];
                player.style.left = `${serverPlayers[id].x}px`;
                player.style.top = `${serverPlayers[id].y}px`;
            }

            for (let id in players) {
                if (!serverPlayers[id]) {
                    if (players[id]) {
                        players[id].remove();
                    }
                    delete players[id];
                }
            }
        });

        socket.on('updateBrainRots', (serverBrainRots) => {
            try {
                // Validate server data
                if (!serverBrainRots || typeof serverBrainRots !== 'object') {
                    console.error('Invalid brainRots data received');
                    return;
                }

                // Remove Brain Rots que nÃ£o existem mais
                for (let id in brainRots) {
                    if (!serverBrainRots[id]) {
                        if (brainRots[id]) {
                            brainRotPool.release(brainRots[id]);
                        }
                        delete brainRots[id];
                    }
                }

                // Adiciona ou atualiza Brain Rots
                for (let id in serverBrainRots) {
                    const rotData = serverBrainRots[id];

                    // Validate rot data
                    if (!rotData || typeof rotData !== 'object' ||
                        typeof rotData.x !== 'number' || typeof rotData.y !== 'number') {
                        console.error('Invalid rot data for id:', id);
                        continue;
                    }

                    if (!brainRots[id]) {
                        const rotDiv = brainRotPool.create();
                        if (!rotDiv) {
                            console.error('Failed to create Brain Rot element');
                            continue;
                        }

                        rotDiv.className = `brain-rot-item ${rotData.class || 'common'}`;
                        rotDiv.id = `rot-${id}`;
                        rotDiv.style.display = 'block';

                        const rotType = BRAIN_ROT_TYPES.find(type => type.name === rotData.name);
                        const price = rotType ? rotType.price : 0;
                        const rarity = rotData.rarity || 'Comum';
                        const name = rotData.name || 'Unknown';

                        rotDiv.innerHTML = `${name}<br>(${rarity})<br><span style="color: #ffeb3b; font-weight: bold;">$${price}</span>`;
                        brainRots[id] = rotDiv;

                        // Create spawn particles
                        particleSystem.createParticle(rotData.x + 20, rotData.y + 20, 'spawn', 8);

                        rotDiv.addEventListener('click', () => {
                            // Prevent multiple clicks
                            if (rotDiv.classList.contains('collecting')) return;

                            // Add collecting animation
                            rotDiv.classList.add('collecting');

                            socket.emit('pickUpBrainRot', { rotId: id });
                            soundManager.play(soundManager.pickupSound);
                            // Create collect particles
                            particleSystem.createParticle(rotData.x + 20, rotData.y + 20, 'collect', 6);

                            // Remove the element after animation
                            setTimeout(() => {
                                if (rotDiv && rotDiv.parentNode) {
                                    brainRotPool.release(rotDiv);
                                    delete brainRots[id];
                                }
                            }, 300);
                        });
                    }

                    const rotDiv = brainRots[id];
                    if (rotDiv) {
                        // Posiciona o Brain Rot corretamente no game area
                        rotDiv.style.left = `${rotData.x}px`;
                        rotDiv.style.top = `${rotData.y}px`;
                    }
                }
            } catch (error) {
                console.error('Error in updateBrainRots:', error);
            }
        });

        socket.on('updateInventories', (serverPlayers) => {
            console.log('updateInventories received:', Object.keys(serverPlayers).length, 'players');
            if (serverPlayers[myId]) {
                console.log('My inventory:', serverPlayers[myId].inventory.length, 'items');
            }

            // Clear all base slots
            for (let i = 1; i <= 6; i++) {
                const base = document.getElementById(`base-${i}`);
                const slots = base.querySelectorAll('.slot');
                slots.forEach(slot => {
                    slot.innerHTML = '';
                    slot.className = 'slot';
                });
            }

            // Populate slots with inventories
            for (let playerId in serverPlayers) {
                const player = serverPlayers[playerId];
                const base = document.getElementById(player.baseId);
                if (base) {
                    const slots = base.querySelectorAll('.slot');
                    player.inventory.forEach((rot, index) => {
                        if (slots[index]) {
                            // Find the brainrot type to get sell price
                            const rotType = BRAIN_ROT_TYPES.find(type => type.name === rot.name);
                            const sellPrice = rotType ? rotType.sellPrice : 0;

                            let content = `${rot.name}<br>(${rot.rarity})<br><span style="color: #ffeb3b; font-weight: bold;">$${sellPrice}</span>`;
                            if (playerId === myId) {
                                // Add sell button for own base
                                content += '<br><button class="sell-btn" data-rot-id="' + rot.id + '">Vender</button>';
                            }
                            slots[index].innerHTML = content;
                            slots[index].classList.add(rot.class);

                            // Add sell button event listener
                            if (playerId === myId) {
                                const sellBtn = slots[index].querySelector('.sell-btn');
                                if (sellBtn) {
                                    sellBtn.addEventListener('click', () => {
                                        sellRot(rot.id);
                                    });
                                }
                            }

                            if (playerId !== myId) {
                                // Allow stealing from other bases
                                slots[index].addEventListener('click', () => {
                                    socket.emit('stealBrainRot', { targetPlayerId: playerId, rotId: rot.id });
                                    showModal(`Tentando roubar ${rot.name}!`);
                                    soundManager.play(soundManager.stealSound);

                                    // Create steal particles at the target base
                                    const targetBase = document.getElementById(player.baseId);
                                    if (targetBase) {
                                        const rect = targetBase.getBoundingClientRect();
                                        const gameRect = gameArea.getBoundingClientRect();
                                        const x = rect.left - gameRect.left + rect.width / 2;
                                        const y = rect.top - gameRect.top + rect.height / 2;
                                        particleSystem.createParticle(x, y, 'steal', 12);
                                    }
                                });
                            }
                        }
                    });
                }
            }
        });

        function sellRot(rotId) {
            socket.emit('sellBrainRot', { rotId });
            soundManager.play(soundManager.sellSound);

            // Create sell particles at the base position
            const myBase = document.getElementById(`base-${myPlayer.baseNumber}`);
            if (myBase) {
                const rect = myBase.getBoundingClientRect();
                const gameRect = gameArea.getBoundingClientRect();
                const x = rect.left - gameRect.left + rect.width / 2;
                const y = rect.top - gameRect.top + rect.height / 2;
                particleSystem.createParticle(x, y, 'sell', 10);
            }
        }

        // Notification system
        let notificationQueue = [];
        let isNotificationShowing = false;

        function showNotification(message, type = 'success', duration = 3000) {
            notificationQueue.push({ message, type, duration });

            if (!isNotificationShowing) {
                showNextNotification();
            }
        }

        function showNextNotification() {
            if (notificationQueue.length === 0) {
                isNotificationShowing = false;
                return;
            }

            isNotificationShowing = true;
            const { message, type, duration } = notificationQueue.shift();

            // Remove existing notification
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);

            // Auto-hide
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                    showNextNotification();
                }, 300);
            }, duration);
        }

        // Modal functions
        function showModal(message, type = 'info') {
            const modalMessage = document.getElementById('modal-message');
            const modal = document.getElementById('modal');

            modalMessage.textContent = message;

            // Update modal styling based on type
            modal.className = `modal ${type}`;

            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        document.getElementById('modal-close').addEventListener('click', hideModal);

        // Mobile compatibility
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   window.innerWidth <= 768;
        }

        // Touch event handling for mobile
        if (isMobile()) {
            document.addEventListener('touchstart', function() {}, { passive: true });
            console.log('Mobile device detected, touch events enabled');
        }

        let selectedDuration = 30000; // Default 30s

        document.getElementById('admin-button').addEventListener('click', () => {
            socket.emit('triggerAdminEvent', { duration: selectedDuration });
        });

        document.getElementById('duration-30').addEventListener('click', () => {
            selectedDuration = 30000;
            showModal('DuraÃ§Ã£o definida para 30 segundos');
        });

        document.getElementById('duration-60').addEventListener('click', () => {
            selectedDuration = 60000;
            showModal('DuraÃ§Ã£o definida para 60 segundos');
        });

        document.getElementById('duration-120').addEventListener('click', () => {
            selectedDuration = 120000;
            showModal('DuraÃ§Ã£o definida para 120 segundos');
        });

        // Base locking functionality
        for (let i = 1; i <= 6; i++) {
            const lockBtn = document.getElementById(`lock-base-${i}`);
            if (lockBtn) {
                lockBtn.addEventListener('click', () => {
                    socket.emit('lockBase');
                    soundManager.play(soundManager.lockSound);
                });
            }
        }

        // Upgrade functionality
        const upgradeBtns = document.querySelectorAll('.upgrade-btn');
        upgradeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const baseNumber = btn.id.split('-')[2]; // Extract base number from button id
                const upgradeType = btn.classList.contains('capacity-btn') ? 'capacity' : 'generation';
                socket.emit('upgradeBase', { upgradeType, baseNumber: parseInt(baseNumber) });
            });
        });

        gameLoop();
    }
</script>

</body>
</html>
